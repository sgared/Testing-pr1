<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sign In • Mont Clay Admin</title>
    <meta
      name="description"
      content="Sign in to the Mont Clay Tech Co. admin dashboard."
    />
    <meta name="robots" content="noindex,nofollow" />

    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%23173542'/%3E%3Ctext x='16' y='22' text-anchor='middle' fill='%23F9F6EE' font-family='system-ui' font-size='14' font-weight='800'%3EMC%3C/text%3E%3C/svg%3E"
    />
    <link href="css/login.css" rel="stylesheet" />
  </head>
  <body>
    <main>
      <header class="page-header">
        <div class="admin-brand">
          <div class="admin-logo" aria-hidden="true">
            <img src="assets/logo.PNG" alt="Mont Clay Tech Co." />
          </div>
          <h1 class="page-title">Admin Sign In</h1>
        </div>
        <p class="page-subtitle">Use your admin account to continue.</p>
      </header>

      <form id="loginForm" class="form-grid" novalidate>
        <div class="form-group">
          <label class="detail-label" for="loginEmail">Email Address</label>
          <input
            id="loginEmail"
            type="email"
            class="form-input"
            placeholder="admin@montclaytech.com"
            required
            autocomplete="email"
            inputmode="email"
            spellcheck="false"
          />
        </div>

        <div class="form-group">
          <label class="detail-label" for="loginPassword">Password</label>
          <input
            id="loginPassword"
            type="password"
            class="form-input"
            placeholder="Enter your password"
            required
            autocomplete="current-password"
          />
        </div>

        <button type="submit" class="btn primary" id="loginSubmit">
          Sign In to Dashboard
        </button>

        <!-- Small links row -->
        <div class="auth-links">
          <a href="index.html" class="link-muted">← Back to site</a>
          <a href="#" id="resetPasswordLink" class="link-accent"
            >Forgot password? Reset via email</a
          >
        </div>

        <div id="loginStatus" class="detail-message" aria-live="polite"></div>
      </form>
    </main>

    <script type="module">
      import { auth, db } from "./js/firebaseConfig.js";
      import {
        onAuthStateChanged,
        signInWithEmailAndPassword,
        sendPasswordResetEmail,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const loginForm = document.getElementById("loginForm");
      const emailEl = document.getElementById("loginEmail");
      const passEl = document.getElementById("loginPassword");
      const submitBtn = document.getElementById("loginSubmit");
      const statusEl = document.getElementById("loginStatus");
      const resetLink = document.getElementById("resetPasswordLink");

      // Strip spaces in email as you type (avoids hidden whitespace issues)
      emailEl?.addEventListener("input", () => {
        const cur = emailEl.value;
        const noSpaces = cur.replace(/\s+/g, "");
        if (cur !== noSpaces) emailEl.value = noSpaces;
      });

      function busy(on) {
        [emailEl, passEl, submitBtn].forEach((el) => el && (el.disabled = on));
      }
      function msg(t, err = false) {
        statusEl.textContent = t || "";
        statusEl.classList.toggle("error", !!err);
        statusEl.style.color = err ? "#842029" : "#173542";
      }
      async function isAdminUser(user) {
        try {
          const token = await user.getIdTokenResult(true);
          if (token?.claims?.admin === true) return true;
        } catch {}
        try {
          const snap = await getDoc(doc(db, "admins", user.uid));
          if (snap.exists() && (snap.data()?.active ?? true)) return true;
        } catch {}
        return false;
      }

      loginForm?.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Basic client-side validation + hard trim
        const email = (emailEl.value || "").trim();
        const password = passEl.value || "";
        if (!email || !password) {
          msg("Email and password are required.", true);
          return;
        }

        busy(true);
        msg("Signing in…");
        try {
          await signInWithEmailAndPassword(auth, email, password);
          // onAuthStateChanged will handle redirect
        } catch (err) {
          console.error(err);
          msg("Sign-in failed. Check your credentials and try again.", true);
        } finally {
          busy(false);
        }
      });

      resetLink?.addEventListener("click", async (e) => {
        e.preventDefault();
        const email = (emailEl.value || "").trim();
        if (!email) {
          msg("Enter your email first to receive reset instructions.", true);
          return;
        }
        busy(true);
        try {
          await sendPasswordResetEmail(auth, email);
          msg(
            "If an account exists for that email, you'll receive reset instructions. Please check your email."
          );
        } catch (err) {
          console.error(err);
          msg(
            "Could not send reset email at the moment. Try again later.",
            true
          );
        } finally {
          busy(false);
        }
      });

      onAuthStateChanged(auth, async (user) => {
        if (!user) return; // stay on login
        const ok = await isAdminUser(user);
        if (ok) {
          window.location.href = "admin.html";
        } else {
          msg("This account is not an admin.", true);
          try {
            await signOut(auth);
          } catch {}
        }
      });
    </script>
  </body>
</html>
